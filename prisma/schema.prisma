// TODO - Logika penilaian taksiran jaminan
generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

model User {
  id       String   @id @default(uuid()) @map("id") @db.VarChar(56)
  name     String   @map("name") @db.VarChar(100)
  username String   @unique @map("username") @db.VarChar(50)
  email    String   @unique @map("email") @db.VarChar(150)
  phone    String?  @unique @map("phone") @db.VarChar(20)
  avatar   String?  @map("avatar")
  image    String?  @map("image")
  role     UserRole @default(ADMIN) @map("role")

  settings    Settings?
  permissions Permissions?
  customer    Customer? // Relasi one-to-one dengan Customer

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([id], name: "idx_user_id")
  @@index([username], name: "idx_user_username")
  @@index([name], name: "idx_user_name")
  @@index([email], name: "idx_user_email")
  @@index([phone], name: "idx_user_phone")
  @@index([avatar], name: "idx_user_avatar")
  @@index([image], name: "idx_user_image")
  @@index([role], name: "idx_user_role")
  @@index([createdAt], name: "idx_user_created_at")
  @@index([updatedAt], name: "idx_user_updated_at")
  @@map("users")
}

model Settings {
  id           String   @id @default(uuid()) @map("id") @db.VarChar(56)
  theme        Theme    @default(SYSTEM) @map("theme")
  language     Language @default(ID) @map("language")
  notification Boolean  @default(true) @map("notification")

  userId String @unique @map("user_id") @db.VarChar(56)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([id], name: "idx_settings_id")
  @@index([theme], name: "idx_settings_theme")
  @@index([language], name: "idx_settings_language")
  @@index([notification], name: "idx_settings_notification")
  @@index([userId], name: "idx_settings_user_id")
  @@index([createdAt], name: "idx_settings_created_at")
  @@index([updatedAt], name: "idx_settings_updated_at")
  @@map("settings")
}

model Permissions {
  id           String  @id @default(uuid()) @map("id") @db.VarChar(56)
  createReport Boolean @default(false) @map("create_report")

  userId String @unique @map("user_id") @db.VarChar(56)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([id], name: "idx_permissions_id")
  @@index([createReport], name: "idx_permissions_create_report")
  @@index([userId], name: "idx_permissions_user_id")
  @@index([createdAt], name: "idx_permissions_created_at")
  @@index([updatedAt], name: "idx_permissions_updated_at")
  @@map("permissions")
}

model Notification {
  id      String @id @default(uuid()) @map("id") @db.VarChar(56)
  slug    String @map("slug") @db.VarChar(255)
  title   String @map("title") @db.VarChar(150)
  message String @map("message") @db.VarChar(255)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("notifications")
}

model Customer {
  id               String         @id @default(uuid()) @map("id") @db.VarChar(56)
  fullName         String         @map("full_name") @db.VarChar(150) // Nama lengkap nasabah
  nationalId       String         @unique @map("national_id") @db.VarChar(20) // NIK/KTP
  birthPlace       String         @map("birth_place") @db.VarChar(100) // Tempat lahir
  birthDate        DateTime       @map("birth_date") @db.Date // Tanggal lahir
  gender           Gender         @map("gender") // Jenis kelamin
  phone            String         @map("phone") @db.VarChar(20) // Nomor telepon
  email            String?        @map("email") @db.VarChar(150) // Email nasabah
  address          String         @map("address") @db.Text // Alamat lengkap
  maritalStatus    MaritalStatus  @map("marital_status") // Status pernikahan
  employmentType   EmploymentType @map("employment_type") // Jenis pekerjaan
  employmentName   String?        @map("employment_name") @db.VarChar(150) // Nama perusahaan/usaha
  employmentPeriod Int?           @map("employment_period") // Lama bekerja (dalam bulan)

  userId String? @unique @map("user_id") @db.VarChar(56) // Relasi dengan User (opsional untuk pengajuan offline)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  document           Document? // Dokumen-dokumen Customer
  bankAccount        BankAccount?
  creditApplications CreditApplication[] // Pengajuan kredit
  guarantors         Guarantor[] // Guarantor sebagai penjamin 

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("customers")
}

model BankAccount {
  id            String @id @default(uuid()) @map("id") @db.VarChar(56)
  accountNumber String @map("account_number")

  customerId String   @unique @map("customer_id")
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([id], name: "idx_bank_account_id")
  @@map("bank_accounts")
}

model Guarantor {
  id               String         @id @default(uuid()) @map("id") @db.VarChar(56)
  fullName         String         @map("full_name") @db.VarChar(150) // Nama lengkap penjamin
  nationalId       String         @map("national_id") @db.VarChar(20) // NIK/KTP penjamin
  birthPlace       String         @map("birth_place") @db.VarChar(100) // Tempat lahir
  birthDate        DateTime       @map("birth_date") @db.Date // Tanggal lahir
  gender           Gender         @map("gender") // Jenis kelamin
  address          String         @map("address") @db.Text // Alamat lengkap
  phone            String         @map("phone") @db.VarChar(20) // Nomor telepon
  email            String?        @map("email") @db.VarChar(150) // Email penjamin
  maritalStatus    MaritalStatus  @map("marital_status") // Status pernikahan
  employmentType   EmploymentType @map("employment_type") // Jenis pekerjaan
  employmentName   String?        @map("employment_name") @db.VarChar(150) // Nama perusahaan/usaha
  employmentPeriod Int?           @map("employment_period") // Lama bekerja (dalam bulan)
  relationship     Relationship   @map("relationship") // Hubungan dengan peminjam

  customerId String   @map("customer_id") @db.VarChar(56) // Relasi dengan Customer yang dijamin
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  document           Document? // Dokumen-dokumen Guarantor
  creditApplications CreditApplication[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("guarantors")
}

model Document {
  id            String  @id @default(uuid()) @map("id") @db.VarChar(56)
  IdentityCard  String? @map("identity_card") // Gambar KTP
  familyCard    String? @map("family_card") // Gambar KK
  salarySlip    String? @map("salary_slip") // Slip gaji
  bankStatement String? @map("bank_statement") // Rekening koran

  customerId  String?    @unique @map("customer_id") @db.VarChar(56) // Relasi opsional dengan Customer
  customer    Customer?  @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  guarantorId String?    @unique @map("guarantor_id") @db.VarChar(56) // Relasi opsional dengan Guarantor
  guarantor   Guarantor? @relation(fields: [guarantorId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("documents")
}

model CreditApplication {
  id                String            @id @default(uuid()) @map("id") @db.VarChar(56)
  applicationNumber String            @unique @map("application_number") @db.VarChar(50) // Nomor pengajuan
  loanType          LoanType          @map("loan_type") // Jenis pinjaman
  loanAmount        Int               @map("loan_amount") // Jumlah pinjaman yang diajukan
  loanPeriod        Int               @map("loan_period") // Jangka waktu (bulan)
  loanPurpose       String?           @map("loan_purpose") @db.Text // Tujuan pinjaman
  collateralCert    String?           @map("collateral_cert") // Sertifikat agunan
  collateralValue   Int?              @map("collateral_value") // Nilai agunan (jika ada)
  monthlyIncome     Int               @map("monthly_income") // Pendapatan per bulan
  incomeProof       String?           @map("income_proof") // Bukti pembayaran
  monthlyExpenses   Int               @map("monthly_expenses") // Pengeluaran per bulan
  surplus           Int               @map("surplus") // Surplus (pendapatan - pengeluaran) per bulan
  status            ApplicationStatus @default(DRAFT) @map("status") // Status pengajuan
  submittedAt       DateTime?         @map("submitted_at") // Tanggal pengajuan
  reviewedAt        DateTime?         @map("reviewed_at") // Tanggal ditinjau
  approvedAt        DateTime?         @map("approved_at") // Tanggal disetujui
  rejectedAt        DateTime?         @map("rejected_at") // Tanggal ditolak
  rejectionReason   String?           @map("rejection_reason") @db.Text // Alasan penolakan
  disbursedAt       DateTime?         @map("disbursed_at") // Tanggal pencairan
  reviewedBy        String?           @map("reviewed_by") @db.VarChar(56) // ID admin yang meninjau
  approvedBy        String?           @map("approved_by") @db.VarChar(56) // ID admin yang menyetujui
  notes             String?           @map("notes") @db.Text // Catatan tambahan

  customerId       String            @map("customer_id") @db.VarChar(56) // Relasi dengan Customer
  customer         Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  guarantorId      String            @map("guarantor_id") @db.VarChar(56) // Relasi opsional dengan Guarantor
  guarantor        Guarantor         @relation(fields: [guarantorId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  loanReference    LoanReference? // Referensi pinjaman jika disetujui
  creditWorthiness CreditWorthiness? // Penilaian kelayakan kredit

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("credit_applications")
}

model CreditWorthiness {
  id               String      @id @default(uuid()) @map("id") @db.VarChar(56)
  creditScore      CreditScore @map("credit_score") // Skor kredit
  assessmentResult String      @map("assessment_result") @db.Text // Hasil penilaian
  assessedBy       String      @map("assessed_by") @db.VarChar(56) // ID admin yang menilai
  assessedAt       DateTime    @default(now()) @map("assessed_at") // Tanggal penilaian

  creditApplicationId String            @unique @map("credit_application_id") @db.VarChar(56)
  creditApplication   CreditApplication @relation(fields: [creditApplicationId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("credit_worthinesses")
}

model LoanReference {
  id              String     @id @default(uuid()) @map("id") @db.VarChar(56)
  loanNumber      String     @unique @map("loan_number") @db.VarChar(50) // Nomor pinjaman
  principalAmount Int        @map("principal_amount") // Jumlah pokok pinjaman
  interestRate    Int        @map("interest_rate") // Suku bunga per tahun (%)
  loanPeriod      Int        @map("loan_period") // Jangka waktu (bulan)
  monthlyPayment  Int        @map("monthly_payment") // Angsuran per bulan
  totalPayment    Int        @map("total_payment") // Total pembayaran
  status          LoanStatus @default(ACTIVE) @map("status") // Status pinjaman
  startDate       DateTime   @map("start_date") @db.Date // Tanggal mulai
  endDate         DateTime   @map("end_date") @db.Date // Tanggal jatuh tempo
  nextPaymentDate DateTime   @map("next_payment_date") @db.Date // Tanggal pembayaran berikutnya
  overdueCount    Int        @default(0) @map("overdue_count") // Jumlah tunggakan
  lateFeeAmount   Int        @default(0) @map("late_fee_amount") // Denda keterlambatan

  creditApplicationId String            @unique @map("credit_application_id") @db.VarChar(56)
  creditApplication   CreditApplication @relation(fields: [creditApplicationId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  loanBalance    LoanBalance? // Saldo pinjaman
  paymentRecords PaymentRecord[] // Riwayat pembayaran

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("loan_references")
}

model LoanBalance {
  id                 String    @id @default(uuid()) @map("id") @db.VarChar(56)
  principalRemaining Int       @map("principal_remaining") // Sisa pokok pinjaman
  interestRemaining  Int       @map("interest_remaining") // Sisa bunga
  totalRemaining     Int       @map("total_remaining") // Total sisa pinjaman
  principalPaid      Int       @map("principal_paid") // Pokok yang sudah dibayar
  interestPaid       Int       @map("interest_paid") // Bunga yang sudah dibayar
  totalPaid          Int       @map("total_paid") // Total yang sudah dibayar
  lateFeeTotal       Int       @default(0) @map("late_fee_total") // Total denda
  lastPaymentDate    DateTime? @map("last_payment_date") @db.Date // Tanggal pembayaran terakhir
  lastPaymentAmount  Int       @default(0) @map("last_payment_amount") // Jumlah pembayaran terakhir

  loanReferenceId String        @unique @map("loan_reference_id") @db.VarChar(56)
  loanReference   LoanReference @relation(fields: [loanReferenceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("loan_balances")
}

model PaymentRecord {
  id                String        @id @default(uuid()) @map("id") @db.VarChar(56)
  installmentNumber Int           @map("installment_number") // Angsuran ke-
  dueDate           DateTime      @map("due_date") @db.Date // Tanggal jatuh tempo
  paymentDate       DateTime?     @map("payment_date") @db.Date // Tanggal pembayaran
  scheduledAmount   Int           @map("scheduled_amount") // Jumlah terjadwal
  paidAmount        Int           @default(0) @map("paid_amount") // Jumlah yang dibayar
  principalAmount   Int           @map("principal_amount") // Jumlah pokok
  interestAmount    Int           @map("interest_amount") // Jumlah bunga
  lateFeeAmount     Int           @default(0) @map("late_fee_amount") // Denda keterlambatan
  status            PaymentStatus @default(PENDING) @map("status") // Status pembayaran
  daysOverdue       Int           @default(0) @map("days_overdue") // Hari keterlambatan

  loanReferenceId String        @map("loan_reference_id") @db.VarChar(56)
  loanReference   LoanReference @relation(fields: [loanReferenceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("payment_records")
}

model Report {
  id String @id @default(uuid()) @map("id") @db.VarChar(56)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("reports")
}
