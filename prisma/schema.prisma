generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum LoginProvider {
  EMAIL  @map("email")
  GOOGLE @map("google")

  @@map("login_provider")
}

enum UserRole {
  ADMIN    @map("admin")
  CUSTOMER @map("customer")

  @@map("user_role")
}

model User {
  id       String   @id @default(uuid()) @map("id") @db.VarChar(56)
  name     String   @map("name") @db.VarChar(100)
  username String   @unique @map("username") @db.VarChar(50)
  email    String   @unique @map("email") @db.VarChar(150)
  phone    String?  @unique @map("phone") @db.VarChar(20)
  avatar   String?  @map("avatar")
  image    String?  @map("image")
  role     UserRole @default(ADMIN) @map("role")

  settings    Settings?
  permissions Permissions?
  customer    Customer? // Relasi one-to-one dengan Customer

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([id], name: "idx_user_id")
  @@index([username], name: "idx_user_username")
  @@index([name], name: "idx_user_name")
  @@index([email], name: "idx_user_email")
  @@index([phone], name: "idx_user_phone")
  @@index([avatar], name: "idx_user_avatar")
  @@index([image], name: "idx_user_image")
  @@index([role], name: "idx_user_role")
  @@index([createdAt], name: "idx_user_created_at")
  @@index([updatedAt], name: "idx_user_updated_at")
  @@map("users")
}

enum Theme {
  LIGHT  @map("light")
  DARK   @map("dark")
  SYSTEM @map("system")

  @@map("theme")
}

enum Language {
  EN @map("en")
  ID @map("id")
  KR @map("kr")
  JP @map("jp")

  @@map("language")
}

enum Currency {
  IDR @map("id-ID")
  USD @map("en-US")
  JPY @map("ja-JP")
  KRW @map("ko-KR")

  @@map("currency")
}

model Settings {
  id           String   @id @default(uuid()) @map("id") @db.VarChar(56)
  theme        Theme    @default(SYSTEM) @map("theme")
  language     Language @default(ID) @map("language")
  currency     Currency @default(IDR) @map("currency")
  notification Boolean  @default(true) @map("notification")

  userId String @unique @map("user_id") @db.VarChar(56)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([id], name: "idx_settings_id")
  @@index([theme], name: "idx_settings_theme")
  @@index([language], name: "idx_settings_language")
  @@index([currency], name: "idx_settings_currency")
  @@index([notification], name: "idx_settings_notification")
  @@index([userId], name: "idx_settings_user_id")
  @@index([createdAt], name: "idx_settings_created_at")
  @@index([updatedAt], name: "idx_settings_updated_at")
  @@map("settings")
}

model Permissions {
  id           String  @id @default(uuid()) @map("id") @db.VarChar(56)
  createReport Boolean @default(false) @map("create_report")

  userId String @unique @map("user_id") @db.VarChar(56)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([id], name: "idx_permissions_id")
  @@index([createReport], name: "idx_permissions_create_report")
  @@index([userId], name: "idx_permissions_user_id")
  @@index([createdAt], name: "idx_permissions_created_at")
  @@index([updatedAt], name: "idx_permissions_updated_at")
  @@map("permissions")
}

model Notification {
  id      String @id @default(uuid()) @map("id") @db.VarChar(56)
  slug    String @map("slug") @db.VarChar(255)
  title   String @map("title") @db.VarChar(150)
  message String @map("message") @db.VarChar(255)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("notifications")
}

enum Gender {
  MALE   @map("male")
  FEMALE @map("female")

  @@map("gender")
}

enum MaritalStatus {
  SINGLE   @map("single")
  MARRIED  @map("married")
  DIVORCED @map("divorced")
  WIDOWED  @map("widowed")

  @@map("marital_status")
}

enum EmploymentType {
  PERMANENT  @map("permanent")
  CONTRACT   @map("contract")
  FREELANCE  @map("freelance")
  BUSINESS   @map("business")
  UNEMPLOYED @map("unemployed")

  @@map("employment_type")
}

model Customer {
  id               String         @id @default(uuid()) @map("id") @db.VarChar(56)
  fullName         String         @map("full_name") @db.VarChar(150) // Nama lengkap nasabah
  identityNumber   String         @unique @map("identity_number") @db.VarChar(20) // NIK/KTP
  birthPlace       String         @map("birth_place") @db.VarChar(100) // Tempat lahir
  birthDate        DateTime       @map("birth_date") @db.Date // Tanggal lahir
  gender           Gender         @map("gender") // Jenis kelamin
  phone            String         @map("phone") @db.VarChar(20) // Nomor telepon
  email            String?        @map("email") @db.VarChar(150) // Email nasabah
  address          String         @map("address") @db.Text // Alamat lengkap
  maritalStatus    MaritalStatus  @map("marital_status") // Status pernikahan
  employmentType   EmploymentType @map("employment_type") // Jenis pekerjaan
  employmentName   String?        @map("employment_name") @db.VarChar(150) // Nama perusahaan/usaha
  employmentPeriod Int?           @map("employment_period") // Lama bekerja (dalam bulan)

  userId String? @unique @map("user_id") @db.VarChar(56) // Relasi dengan User (opsional untuk pengajuan offline)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  document           Document? // Dokumen-dokumen Customer
  creditApplications CreditApplication[] // Pengajuan kredit
  guarantors         Guarantor[] // Customer sebagai penjamin orang lain

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("customers")
}

model Guarantor {
  id             String   @id @default(uuid()) @map("id") @db.VarChar(56)
  fullName       String   @map("full_name") @db.VarChar(150) // Nama lengkap penjamin
  identityNumber String   @map("identity_number") @db.VarChar(20) // NIK/KTP penjamin
  birthPlace     String   @map("birth_place") @db.VarChar(100) // Tempat lahir
  birthDate      DateTime @map("birth_date") @db.Date // Tanggal lahir
  gender         Gender   @map("gender") // Jenis kelamin
  address        String   @map("address") @db.Text // Alamat lengkap
  phone          String   @map("phone") @db.VarChar(20) // Nomor telepon
  relationship   String   @map("relationship") @db.VarChar(50) // Hubungan dengan peminjam

  customerId String   @map("customer_id") @db.VarChar(56) // Relasi dengan Customer yang dijamin
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  document           Document? // Dokumen-dokumen Guarantor
  creditApplications CreditApplication[]

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("guarantors")
}

model Document {
  id             String  @id @default(uuid()) @map("id") @db.VarChar(56)
  IdentityCard   String? @map("identity_card") // Gambar KTP
  familyCard     String? @map("family_card") // Gambar KK
  salarySlip     String? @map("salary_slip") // Slip gaji
  taxReport      String? @map("tax_report") // SPT
  businessPermit String? @map("business_permit") // SIUP/TDP
  bankStatement  String? @map("bank_statement") // Rekening koran
  collateralCert String? @map("collateral_cert") // Sertifikat jaminan

  customerId  String?    @unique @map("customer_id") @db.VarChar(56) // Relasi opsional dengan Customer
  customer    Customer?  @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  guarantorId String?    @unique @map("guarantor_id") @db.VarChar(56) // Relasi opsional dengan Guarantor
  guarantor   Guarantor? @relation(fields: [guarantorId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("documents")
}

// === LOAN APPLICATION SECTION ===

enum LoanType {
  PERSONAL     @map("personal") // Kredit tanpa agunan
  MORTGAGE     @map("mortgage") // KPR
  VEHICLE      @map("vehicle") // Kredit kendaraan
  BUSINESS     @map("business") // Kredit usaha
  MULTIPURPOSE @map("multipurpose") // Kredit multiguna

  @@map("loan_type")
}

enum ApplicationStatus {
  DRAFT     @map("draft") // Draft
  SUBMITTED @map("submitted") // Diajukan
  REVIEWING @map("reviewing") // Sedang ditinjau
  APPROVED  @map("approved") // Disetujui
  REJECTED  @map("rejected") // Ditolak
  DISBURSED @map("disbursed") // Dicairkan
  CANCELLED @map("cancelled") // Dibatalkan

  @@map("application_status")
}

model CreditApplication {
  id                String            @id @default(uuid()) @map("id") @db.VarChar(56)
  applicationNumber String            @unique @map("application_number") @db.VarChar(50) // Nomor pengajuan
  loanType          LoanType          @map("loan_type") // Jenis pinjaman
  loanAmount        Decimal           @map("loan_amount") @db.Decimal(15, 2) // Jumlah pinjaman yang diajukan
  loanPeriod        Int               @map("loan_period") // Jangka waktu (bulan)
  loanPurpose       String?           @map("loan_purpose") @db.Text // Tujuan pinjaman
  collateralValue   Decimal?          @map("collateral_value") @db.Decimal(15, 2) // Nilai agunan (jika ada)
  monthlyIncome     Decimal           @map("monthly_income") @db.Decimal(15, 2) // Pendapatan per bulan
  incomeProof       String            @map("income_proof") // Bukti pembayaran
  monthlyExpenses   Int               @map("monthly_expenses") // Pengeluaran per bulan
  surplus           Int               @map("surplus") // Surplus (pendapatan - pengeluaran) per bulan
  status            ApplicationStatus @default(DRAFT) @map("status") // Status pengajuan
  submittedAt       DateTime?         @map("submitted_at") // Tanggal pengajuan
  reviewedAt        DateTime?         @map("reviewed_at") // Tanggal ditinjau
  approvedAt        DateTime?         @map("approved_at") // Tanggal disetujui
  rejectedAt        DateTime?         @map("rejected_at") // Tanggal ditolak
  rejectionReason   String?           @map("rejection_reason") @db.Text // Alasan penolakan
  disbursedAt       DateTime?         @map("disbursed_at") // Tanggal pencairan
  reviewedBy        String?           @map("reviewed_by") @db.VarChar(56) // ID admin yang meninjau
  notes             String?           @map("notes") @db.Text // Catatan tambahan

  customerId       String            @map("customer_id") @db.VarChar(56) // Relasi dengan Customer
  customer         Customer          @relation(fields: [customerId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  guarantorId      String            @map("guarantor_id") @db.VarChar(56) // Relasi opsional dengan Guarantor
  guarantor        Guarantor         @relation(fields: [guarantorId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  loanReference    LoanReference? // Referensi pinjaman jika disetujui
  creditWorthiness CreditWorthiness? // Penilaian kelayakan kredit

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("credit_applications")
}

enum CreditScore {
  EXCELLENT @map("excellent") // 750+
  GOOD      @map("good") // 650-749
  FAIR      @map("fair") // 550-649
  POOR      @map("poor") // 450-549
  BAD       @map("bad") // <450

  @@map("credit_score")
}

model CreditWorthiness {
  id               String      @id @default(uuid()) @map("id") @db.VarChar(56)
  creditScore      CreditScore @map("credit_score") // Skor kredit
  scoreValue       Int         @map("score_value") // Nilai skor numerik
  assessmentResult String      @map("assessment_result") @db.Text // Hasil penilaian
  assessedBy       String      @map("assessed_by") @db.VarChar(56) // ID admin yang menilai
  assessedAt       DateTime    @default(now()) @map("assessed_at") // Tanggal penilaian

  creditApplicationId String            @unique @map("credit_application_id") @db.VarChar(56)
  creditApplication   CreditApplication @relation(fields: [creditApplicationId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("credit_worthinesses")
}

enum LoanStatus {
  ACTIVE    @map("active") // Aktif
  COMPLETED @map("completed") // Lunas
  OVERDUE   @map("overdue") // Menunggak
  DEFAULT   @map("default") // Macet

  @@map("loan_status")
}

model LoanReference {
  id              String     @id @default(uuid()) @map("id") @db.VarChar(56)
  loanNumber      String     @unique @map("loan_number") @db.VarChar(50) // Nomor pinjaman
  principalAmount Decimal    @map("principal_amount") @db.Decimal(15, 2) // Jumlah pokok pinjaman
  interestRate    Decimal    @map("interest_rate") @db.Decimal(5, 2) // Suku bunga per tahun (%)
  loanPeriod      Int        @map("loan_period") // Jangka waktu (bulan)
  monthlyPayment  Decimal    @map("monthly_payment") @db.Decimal(15, 2) // Angsuran per bulan
  totalPayment    Decimal    @map("total_payment") @db.Decimal(15, 2) // Total pembayaran
  status          LoanStatus @default(ACTIVE) @map("status") // Status pinjaman
  startDate       DateTime   @map("start_date") @db.Date // Tanggal mulai
  endDate         DateTime   @map("end_date") @db.Date // Tanggal jatuh tempo
  nextPaymentDate DateTime   @map("next_payment_date") @db.Date // Tanggal pembayaran berikutnya
  overdueCount    Int        @default(0) @map("overdue_count") // Jumlah tunggakan
  lateFeeAmount   Decimal    @default(0) @map("late_fee_amount") @db.Decimal(15, 2) // Denda keterlambatan

  creditApplicationId String            @unique @map("credit_application_id") @db.VarChar(56)
  creditApplication   CreditApplication @relation(fields: [creditApplicationId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  loanBalance    LoanBalance? // Saldo pinjaman
  transactions   Transaction[] // Transaksi pembayaran
  paymentRecords PaymentRecord[] // Riwayat pembayaran

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("loan_references")
}

model LoanBalance {
  id                 String    @id @default(uuid()) @map("id") @db.VarChar(56)
  principalRemaining Decimal   @map("principal_remaining") @db.Decimal(15, 2) // Sisa pokok pinjaman
  interestRemaining  Decimal   @map("interest_remaining") @db.Decimal(15, 2) // Sisa bunga
  totalRemaining     Decimal   @map("total_remaining") @db.Decimal(15, 2) // Total sisa pinjaman
  principalPaid      Decimal   @map("principal_paid") @db.Decimal(15, 2) // Pokok yang sudah dibayar
  interestPaid       Decimal   @map("interest_paid") @db.Decimal(15, 2) // Bunga yang sudah dibayar
  totalPaid          Decimal   @map("total_paid") @db.Decimal(15, 2) // Total yang sudah dibayar
  lateFeeTotal       Decimal   @default(0) @map("late_fee_total") @db.Decimal(15, 2) // Total denda
  lastPaymentDate    DateTime? @map("last_payment_date") @db.Date // Tanggal pembayaran terakhir
  lastPaymentAmount  Decimal   @default(0) @map("last_payment_amount") @db.Decimal(15, 2) // Jumlah pembayaran terakhir

  loanReferenceId String        @unique @map("loan_reference_id") @db.VarChar(56)
  loanReference   LoanReference @relation(fields: [loanReferenceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("loan_balances")
}

enum TransactionType {
  PAYMENT       @map("payment") // Pembayaran
  LATE_FEE      @map("late_fee") // Denda
  EARLY_PAYMENT @map("early_payment") // Pelunasan dipercepat
  REFUND        @map("refund") // Pengembalian

  @@map("transaction_type")
}

enum PaymentMethod {
  CASH          @map("cash") // Tunai
  BANK_TRANSFER @map("bank_transfer") // Transfer bank
  DEBIT_CARD    @map("debit_card") // Kartu debit
  VIRTUAL_ACC   @map("virtual_account") // Virtual account
  E_WALLET      @map("e_wallet") // E-wallet

  @@map("payment_method")
}

model Transaction {
  id                String          @id @default(uuid()) @map("id") @db.VarChar(56)
  transactionNumber String          @unique @map("transaction_number") @db.VarChar(50) // Nomor transaksi
  transactionType   TransactionType @map("transaction_type") // Jenis transaksi
  paymentMethod     PaymentMethod   @map("payment_method") // Metode pembayaran
  amount            Decimal         @map("amount") @db.Decimal(15, 2) // Jumlah transaksi
  principalAmount   Decimal         @map("principal_amount") @db.Decimal(15, 2) // Jumlah pokok
  interestAmount    Decimal         @map("interest_amount") @db.Decimal(15, 2) // Jumlah bunga
  lateFeeAmount     Decimal         @default(0) @map("late_fee_amount") @db.Decimal(15, 2) // Jumlah denda
  transactionDate   DateTime        @default(now()) @map("transaction_date") // Tanggal transaksi
  notes             String?         @map("notes") @db.Text // Catatan

  loanReferenceId String        @map("loan_reference_id") @db.VarChar(56)
  loanReference   LoanReference @relation(fields: [loanReferenceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("transactions")
}

enum PaymentStatus {
  ON_TIME @map("on_time") // Tepat waktu
  LATE    @map("late") // Terlambat
  PENDING @map("pending") // Menunggu

  @@map("payment_status")
}

model PaymentRecord {
  id                String        @id @default(uuid()) @map("id") @db.VarChar(56)
  installmentNumber Int           @map("installment_number") // Angsuran ke-
  dueDate           DateTime      @map("due_date") @db.Date // Tanggal jatuh tempo
  paymentDate       DateTime?     @map("payment_date") @db.Date // Tanggal pembayaran
  scheduledAmount   Decimal       @map("scheduled_amount") @db.Decimal(15, 2) // Jumlah terjadwal
  paidAmount        Decimal       @default(0) @map("paid_amount") @db.Decimal(15, 2) // Jumlah yang dibayar
  principalAmount   Decimal       @map("principal_amount") @db.Decimal(15, 2) // Jumlah pokok
  interestAmount    Decimal       @map("interest_amount") @db.Decimal(15, 2) // Jumlah bunga
  lateFeeAmount     Decimal       @default(0) @map("late_fee_amount") @db.Decimal(15, 2) // Denda keterlambatan
  status            PaymentStatus @default(PENDING) @map("status") // Status pembayaran
  daysOverdue       Int           @default(0) @map("days_overdue") // Hari keterlambatan

  loanReferenceId String        @map("loan_reference_id") @db.VarChar(56)
  loanReference   LoanReference @relation(fields: [loanReferenceId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("payment_records")
}

model Report {
  id String @id @default(uuid()) @map("id") @db.VarChar(56)

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([id], name: "idx_report_id")
  @@map("reports")
}
